/*! HSO D365 CLI 1.0.2 | (c) HSO Innovation */!function(n){var r={};function i(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return n[e].call(t.exports,t,t.exports,i),t.l=!0,t.exports}i.m=n,i.c=r,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(n,r,function(e){return t[e]}.bind(null,r));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=6)}([,function(e,t){e.exports=require("fs")},,,,,function(e,t,n){e.exports=n(7)},function(e,t,n){"use strict";var a=this&&this.__awaiter||function(o,s,u,a){return new(u=u||Promise)(function(e,t){function n(e){try{i(a.next(e))}catch(e){t(e)}}function r(e){try{i(a.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new u(function(e){e(t.value)}).then(n,r)}i((a=a.apply(o,s||[])).next())})},h=this&&this.__generator||function(n,r){var i,o,s,e,u={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;u;)try{if(i=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,o=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(s=0<(s=u.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){u.label=t[1];break}if(6===t[0]&&u.label<s[1]){u.label=s[1],s=t;break}if(s&&u.label<s[2]){u.label=s[2],u.ops.push(t);break}s[2]&&u.ops.pop(),u.trys.pop();continue}t=r.call(n,u)}catch(e){t=[6,e],o=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(t,"__esModule",{value:!0});var r=n(8),v=n(1),o=n(9),d=n(10),s=n(11),c=n(12);function i(){this.sockets=[],this.settings=JSON.parse(v.readFileSync("deploy/crm.json","utf8")),this.adal={authorityHostUrl:"https://login.microsoftonline.com",clientId:process.env.HSO_D365_CLI_ClientId,clientSecret:process.env.HSO_D365_CLI_ClientSecret,redirectUri:this.settings.adal.redirectUri,tenant:this.settings.adal.tenant},this.md5=function(e){return o.createHash("md5").update(e).digest("hex")},this.express=r(),this.mountRoutes(),this.startListen()}(new(i.prototype.startListen=function(){var t=this,e=this.settings.adal.redirectUri.split("/"),n=e[e.length-2].split(":"),r=parseInt(n[1]),i=e.slice(0,e.length-1).join("/")+"/auth";this.httpServer=this.express.listen(r,function(){return s(i),console.log("server is listening on "+r)}),this.httpServer.on("connection",function(e){t.sockets.push(e)})},i.prototype.mountRoutes=function(){var e=r.Router();i.mountDefaultRoute(e),i.mountLoginRoute(e),this.mountAuthRoute(e),this.mountRedirectRoute(e),this.mountDeployRoute(e),this.express.use("/",e)},i.mountDefaultRoute=function(e){e.get("/",function(e,t){t.redirect("login")})},i.mountLoginRoute=function(e){e.get("/login",function(e,t){t.cookie("acookie","this is a cookie"),t.send('<head><title>test</title></head><body><a href="./auth">Login</a></body>')})},i.prototype.mountAuthRoute=function(e){var i=this;e.get("/auth",function(e,r){o.randomBytes(48,function(e,t){var n=t.toString("base64").replace(/\//g,"_").replace(/\+/g,"-");r.cookie("authstate",n),r.redirect(i.createAuthorizationUrl(n))})})},i.prototype.createAuthorizationUrl=function(e){var t=this.adal,n=t.authorityHostUrl,r=t.clientId,i=t.redirectUri,o=t.tenant,s=this.settings.crm.url,u=(n+"/"+o+"/oauth2/authorize?response_type=code&client_id=<client_id>&redirect_uri=<redirect_uri>&state=<state>&resource=<resource>").replace("<client_id>",r);return u=(u=(u=u.replace("<redirect_uri>",i)).replace("<state>",e)).replace("<resource>",s)},i.prototype.mountRedirectRoute=function(e){var l=this,t=this.settings.adal.redirectUri.split("/"),n="/"+t[t.length-1];e.get(n,function(e,r){var t=l.adal,n=t.authorityHostUrl,i=t.clientId,o=t.clientSecret,s=t.redirectUri,u=t.tenant,a=l.settings.crm.url,c=new d.AuthenticationContext(n+"/"+u);c.acquireTokenWithAuthorizationCode(e.query.code,s,a,i,o,function(e,t){var n=e?"error: "+e.message+"\n":"";n+="response: "+JSON.stringify(t),e?r.send(n):c.acquireTokenWithRefreshToken(t.refreshToken,i,o,a,function(e,t){e&&(n+="refreshError: "+e.message+"\n"),n+="refreshResponse: "+JSON.stringify(t),l.bearer=t.accessToken,r.redirect("/deploy")})})})},i.prototype.mountDeployRoute=function(e){var n=this;e.get("/deploy",function(e,t){return a(n,void 0,void 0,function(){return h(this,function(e){switch(e.label){case 0:return t.setHeader("Connection","Transfer-Encoding"),t.setHeader("Content-Type","text/html; charset=utf-8"),t.setHeader("Transfer-Encoding","chunked"),t.flushHeaders(),[4,this.deploy(function(e){t.write(""+e,function(){t.flushHeaders()})})];case 1:return e.sent(),t.send(),[2]}})})})},i.prototype.deploy=function(o){return a(this,void 0,void 0,function(){var t,n,r,i=this;return h(this,function(e){switch(e.label){case 0:return t=this.settings.crm,n=t.publisher_prefix,r=t.url,o("Deploying to "+r+"...<br/>"),[4,this.deployDirectory("dist/"+n+"_",o)];case 1:return e.sent(),o("Deploy finished"),setTimeout(function(){i.httpServer.close(function(){return console.log("server stopped listening")});for(var e=0,t=i.sockets;e<t.length;e++)t[e].destroy()},100),[2]}})})},i.prototype.deployDirectory=function(f,p){return a(this,void 0,void 0,function(){var t=this;return h(this,function(e){return[2,new Promise(function(d){v.readdir(f,function(e,l){return a(t,void 0,void 0,function(){var t,n,r,i,o,s,u,a,c;return h(this,function(e){switch(e.label){case 0:t=[],n=0,r=l,e.label=1;case 1:return n<r.length?(i=r[n],o=f+"/"+i,v.lstatSync(o).isDirectory()?(u=(s=t).push,[4,this.deployDirectory(o,p)]):[3,3]):[3,6];case 2:return u.apply(s,[e.sent()]),[3,5];case 3:return c=(a=t).push,[4,this.deployFile(o,p)];case 4:c.apply(a,[e.sent()]),e.label=5;case 5:return n++,[3,1];case 6:return Promise.all(t).then(function(){d()}),[2]}})})})})]})})},i.prototype.deployFile=function(o,s){return a(this,void 0,void 0,function(){var t=this;return h(this,function(e){return[2,new Promise(function(i){v.readFile(o,function(e,r){return a(t,void 0,void 0,function(){var t,n;return h(this,function(e){switch(e.label){case 0:return t=o.substr(5),[4,this.getWebresource(t)];case 1:return n=e.sent(),s(""+t),n?[4,this.updateWebresource(n,r,s)]:[3,3];case 2:return e.sent(),[3,5];case 3:return[4,this.insertWebresource(r,t,s)];case 4:e.sent(),e.label=5;case 5:return i(),[2]}})})})})]})})},i.prototype.updateWebresource=function(o,s,u){return a(this,void 0,void 0,function(){var t,n,r,i;return h(this,function(e){switch(e.label){case 0:if(t=this.md5(o.content),n=s.toString("base64"),r=this.md5(n),t===r)return[3,6];o.content=n,e.label=1;case 1:return e.trys.push([1,4,,5]),[4,c.WebresourceService.upsert(o,this.bearer)];case 2:return e.sent(),u(" updated..."),[4,c.WebresourceService.publish(o,this.bearer)];case 3:return e.sent(),u(" and published<br/>"),[3,5];case 4:return i=e.sent(),u(" failed "+i.message+"<br/>"),[3,5];case 5:return[3,7];case 6:u(" unmodified<br/>"),e.label=7;case 7:return[2]}})})},i.prototype.insertWebresource=function(o,s,u){return a(this,void 0,void 0,function(){var t,n,r,i;return h(this,function(e){switch(e.label){case 0:t=o.toString("base64"),e.label=1;case 1:return e.trys.push([1,4,,5]),n=this.settings.crm.solution_name,[4,c.WebresourceService.upsert({content:t,name:s,displayname:s},this.bearer)];case 2:return r=e.sent(),u(" inserted..."),[4,c.WebresourceService.addToSolution(r,n,this.bearer)];case 3:return e.sent(),u(" and added to solution "+n+"<br/>"),[2,r];case 4:return i=e.sent(),u(" failed "+i.message+"<br/>"),[3,5];case 5:return[2]}})})},i.prototype.getWebresource=function(t){return a(this,void 0,void 0,function(){return h(this,function(e){switch(e.label){case 0:return[4,c.WebresourceService.retrieveMultipleRecords({select:["name","webresourcetype","content","displayname","solutionid"],filters:[{conditions:[{attribute:"name",value:t}]}],top:1},this.bearer)];case 1:return[2,e.sent()[0]]}})})},i)).express},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("adal-node")},function(e,t){e.exports=require("opn")},function(e,t,n){"use strict";var s=this&&this.__awaiter||function(o,s,u,a){return new(u=u||Promise)(function(e,t){function n(e){try{i(a.next(e))}catch(e){t(e)}}function r(e){try{i(a.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new u(function(e){e(t.value)}).then(n,r)}i((a=a.apply(o,s||[])).next())})},d=this&&this.__generator||function(n,r){var i,o,s,e,u={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;u;)try{if(i=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,o=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(s=0<(s=u.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){u.label=t[1];break}if(6===t[0]&&u.label<s[1]){u.label=s[1],s=t;break}if(s&&u.label<s[2]){u.label=s[2],u.ops.push(t);break}s[2]&&u.ops.pop(),u.trys.pop();continue}t=r.call(n,u)}catch(e){t=[6,e],o=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(t,"__esModule",{value:!0});var f=n(13),r=(p.retrieveMultipleRecords=function(t,n){return s(this,void 0,void 0,function(){return d(this,function(e){return[2,f.NodeApi.retrieveMultipleRecords(p.entitySetName,t,n)]})})},p.upsert=function(i,o){return s(this,void 0,void 0,function(){var t,n,r;return d(this,function(e){switch(e.label){case 0:return i.webresourceid?[4,f.NodeApi.updateRecord(p.entitySetName,i.webresourceid,i,o)]:[3,2];case 1:return e.sent(),[2,i];case 2:return t=i.name.split("."),n=t[t.length-1],r=i,[4,p.getWebresourcetype(n,o)];case 3:return r.webresourcetype=e.sent(),[4,f.NodeApi.insertRecord(p.entitySetName,i,o)];case 4:return[2,e.sent()]}})})},p.publish=function(n,r){return s(this,void 0,void 0,function(){var t;return d(this,function(e){return t={ParameterXml:"<importexportxml><webresources><webresource>{"+n.webresourceid+"}</webresource></webresources></importexportxml>"},[2,f.NodeApi.executeAction("PublishXml",r,t)]})})},p.addToSolution=function(t,n,r){return s(this,void 0,void 0,function(){return d(this,function(e){return[2,f.NodeApi.executeAction("AddSolutionComponent",r,{ComponentId:t.webresourceid,ComponentType:61,SolutionUniqueName:n,AddRequiredComponents:!1,IncludedComponentSettingsValues:null})]})})},p.getWebresourcetype=function(c,l){return s(this,void 0,void 0,function(){var t,n,r,i,o,s,u,a;return d(this,function(e){switch(e.label){case 0:return[4,f.NodeApi.getPicklistOptionSet(p.logicalName,"webresourcetype",l)];case 1:for(t=e.sent(),i=0,o=t;i<o.length;i++)if(s=o[i],u=s.value,(a=s.label).toLocaleLowerCase().includes("script")&&(r=parseInt(String(u),10)),a.toLowerCase().includes(c)){n=parseInt(String(u),10);break}return n||"json"!==c||(n=r),[2,n]}})})},p.logicalName="webresource",p.entitySetName="webresourceset",p);function p(){}t.WebresourceService=r},function(e,t,n){"use strict";var d=this&&this.__awaiter||function(o,s,u,a){return new(u=u||Promise)(function(e,t){function n(e){try{i(a.next(e))}catch(e){t(e)}}function r(e){try{i(a.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new u(function(e){e(t.value)}).then(n,r)}i((a=a.apply(o,s||[])).next())})},f=this&&this.__generator||function(n,r){var i,o,s,e,u={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;u;)try{if(i=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,o=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(s=0<(s=u.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){u.label=t[1];break}if(6===t[0]&&u.label<s[1]){u.label=s[1],s=t;break}if(s&&u.label<s[2]){u.label=s[2],u.ops.push(t);break}s[2]&&u.ops.pop(),u.trys.pop();continue}t=r.call(n,u)}catch(e){t=[6,e],o=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),a=n(14),i=(p.retrieveMultipleRecords=function(o,s,u){return d(this,void 0,void 0,function(){var t,n,r,i;return f(this,function(e){switch(e.label){case 0:return t=p.getSystemQueryOptions(s),n=p.settings.crm,r=n.url,i=n.version,[4,p.request("GET",r+"/api/data/v"+i+"/"+o+t,null,{Authorization:"Bearer "+u})];case 1:return[2,e.sent().body.value]}})})},p.updateRecord=function(i,o,s,u){return d(this,void 0,void 0,function(){var t,n,r;return f(this,function(e){switch(e.label){case 0:return t=p.settings.crm,n=t.url,r=t.version,[4,p.request("PATCH",n+"/api/data/v"+r+"/"+i+"("+o+")",s,{Authorization:"Bearer "+u,Prefer:"return=representation"})];case 1:return[2,e.sent().body]}})})},p.insertRecord=function(i,o,s){return d(this,void 0,void 0,function(){var t,n,r;return f(this,function(e){switch(e.label){case 0:return t=p.settings.crm,n=t.url,r=t.version,[4,p.request("POST",n+"/api/data/v"+r+"/"+i,o,{Authorization:"Bearer "+s,Prefer:"return=representation"})];case 1:return[2,e.sent().body]}})})},p.getPicklistOptionSet=function(i,o,s){return d(this,void 0,void 0,function(){var t,n,r;return f(this,function(e){switch(e.label){case 0:return t=p.settings.crm,n=t.url,r=t.version,[4,p.request("GET",n+"/api/data/v"+r+"/EntityDefinitions(LogicalName='"+i+"')/Attributes(LogicalName='"+o+"')/Microsoft.Dynamics.CRM.PicklistAttributeMetadata?$select=LogicalName&$expand=OptionSet($select=Options)",null,{Authorization:"Bearer "+s})];case 1:return[2,e.sent().body.OptionSet.Options.map(function(e){return{value:e.Value,externalValue:e.ExternalValue,label:e.Label.UserLocalizedLabel.Label}})]}})})},p.executeAction=function(t,n,r,i,o){return d(this,void 0,void 0,function(){return f(this,function(e){return i?[2,this.executeBoundAction(t,n,r,i,o)]:[2,this.executeUnboundAction(t,n,r)]})})},p.executeBoundAction=function(s,u,a,c,l){return d(this,void 0,void 0,function(){var t,n,r,i,o;return f(this,function(e){switch(e.label){case 0:return[4,Xrm.Utility.getEntityMetadata(c)];case 1:return t=e.sent(),n=p.settings.crm,r=n.url,i=n.version,o=r+"/api/data/v"+i+"/"+t.EntitySetName+"("+l+")/Microsoft.Dynamics.CRM."+s,[4,p.request("POST",o,a,{Authorization:"Bearer "+u})];case 2:return[2,e.sent().body]}})})},p.executeUnboundAction=function(o,s,u){return d(this,void 0,void 0,function(){var t,n,r,i;return f(this,function(e){switch(e.label){case 0:return t=u?"POST":"GET",n=p.settings.crm,r=n.url,i=n.version,[4,p.request(t,r+"/api/data/v"+i+"/"+o,u,{Authorization:"Bearer "+s})];case 1:return[2,e.sent().body]}})})},p.getSystemQueryOptions=function(e){var t=e.select,n=e.filters,r=e.top,i=p.generateSelect(t),o=p.generateFilter(n),s=r?"$top="+r:null,u=[];return i&&u.push(i),o&&u.push(o),s&&u.push(s),0<u.length?"?"+u.join("&"):""},p.generateSelect=function(e){return void 0===e&&(e=[]),0<e.length?"$select="+e.join(","):null},p.generateFilter=function(e){void 0===e&&(e=[]);var t=[];if(0<e.length)for(var n=0,r=e;n<r.length;n++){var i=r[n];t.push(p.parseFilter(i))}return 0<t.length?"$filter="+t.join(" and "):null},p.parseFilter=function(e){for(var t=e.type,n=void 0===t?"and":t,r=[],i=0,o=e.conditions;i<o.length;i++){var s=o[i],u=s.attribute,a=s.operator,c=void 0===a?"eq":a,l=s.value,d=u+" "+c;d+="string"==typeof l?" '"+l+"'":" "+l,r.push(d)}return""+r.join(" "+n+" ")},p.request=function(i,o,s,u){return void 0===u&&(u={}),new Promise(function(n,r){var e=p.getRequestOptions(i,o,u,s),t=a.request(e,function(e){var t="";e.setEncoding("utf8"),e.on("data",function(e){return t+=e}),e.on("end",function(){try{n(p.handleNodeHttpsResponse(e,t))}catch(e){r(e)}})});t.on("error",function(e){r(e)}),"GET"!==i&&t.write(s&&JSON.stringify(s)),t.end()})},p.getRequestOptions=function(e,t,n,r){var i=t.split("/"),o=i[2],s="/"+i.slice(3,i.length).join("/"),u=Object.assign({},p.jsonHeaders,n);if("GET"!==e){var a=r&&JSON.stringify(r);u["Content-Length"]=a.length}return{hostname:o,port:443,path:encodeURI(s),method:e,headers:u}},p.handleNodeHttpsResponse=function(t,e){var n={200:function(){return p.dataHandler(t,e)},201:function(){return p.dataHandler(t,e)},204:function(){return{body:"",getResponseHeader:function(e){return t.headers[e]},statusCode:t.statusCode}}}[t.statusCode];if(n)return n();if(401===t.statusCode)throw new Error("Unauthorized");throw new Error(t.statusCode+": "+t.statusMessage+"\n "+e)},p.dataHandler=function(t,e){var n=null;try{n=JSON.parse(e)}catch(e){throw new Error("JSON response can't be parsed")}return{body:n,getResponseHeader:function(e){return t.headers[e]},statusCode:t.statusCode}},p.settings=JSON.parse(r.readFileSync("deploy/crm.json","utf8")),p.jsonHeaders={"OData-MaxVersion":"4.0","OData-Version":"4.0",Accept:"application/json","Content-Type":"application/json; charset=utf-8"},p);function p(){}t.NodeApi=i},function(e,t){e.exports=require("https")}]);